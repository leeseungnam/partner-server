<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.wrightbrothers.apps.order.query.Delivery">

	<select id="findDeliveryList" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryListDto$Param" resultType="kr.wrightbrothers.apps.order.dto.DeliveryListDto$Response">
		-- 배송 관리 목록 조회
		select
			date_format(p.pym_dt, '%Y-%m-%d') as payment_day,
			o.ord_no as order_no,
			m.usr_nm as order_user_name,
			s.ord_stus as order_status_code,
			s.ord_stus as order_status_name,
			p.pay_meth as payment_method_code,
			p.pay_meth as payment_method_name,
			s.ord_nm as order_name,
			g.delivery_name,
			s.rcpnt_nm as recipient_name,
			s.rcpnt_usr_phn as recipient_phone,
			s.rcpnt_adrs as recipient_address,
			s.rcpnt_adrs_sub as recipient_address_detail
		  from ord_info o
		 inner join ord_prnr_info s
		    on o.ord_no = s.ord_no
		  left join com_mbr_info m
		    on o.ord_usr_id = m.usr_id
		 inner join (
		     select
		         _p.ord_no,
		         concat(
		             if(sum(if(_p.dlvr_tp = 'D01', 1, 0)) > 0, '택배', ''),
					 if(sum(if(_p.dlvr_tp = 'D01', 1, 0)) > 0 and sum(if(_p.dlvr_tp = 'D07', 1, 0)) > 0, ' / ', ''),
					 if(sum(if(_p.dlvr_tp = 'D07', 1, 0)) > 0, '화물', '')
				 ) as delivery_name
		       from ord_prdt_info _p
		       left join ord_shpn_info _d
		       	 on _p.ord_no = _d.ord_no
				and _p.ord_prdt_idx = _d.ord_prdt_idx
				and _p.prdt_cd = _d.prdt_cd
			  where _p.prnr_cd = #{partnerCode}
			-- 배송 상태
			<foreach collection="deliveryStatus" item="item" index="index" open="and _p.ord_prdt_stus in (" separator="," close=")">
				#{item}
			</foreach>
			-- 배송 방법
			<foreach collection="deliveryType" item="item" index="index" open="and _p.dlvr_tp in (" separator="," close=")">
				#{item}
			</foreach>
		      group by _p.ord_no
		) g on o.ord_no = g.ord_no
		 inner join ord_pay_info p
			on o.ord_no = p.ord_no
		 where s.prnr_cd = #{partnerCode}
		<choose>
			<when test="keywordValue != null and keywordValue != ''">
				<choose>
					<when test="keywordType == 'NO'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							o.ord_no like #{item} '%'
						</foreach>
					</when>
					<when test="keywordType == 'NAME'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							s.ord_nm like #{item} '%'
						</foreach>
					</when>
					<when test="keywordType == 'USER'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							m.usr_nm like #{item} '%'
						</foreach>
					</when>
				</choose>
			</when>
			<otherwise>
				and	p.pym_dt between concat(#{startDay}, ' 00:00:00.0') and concat(#{endDay}, ' 23:59:59.9')
			</otherwise>
		</choose>
		order by p.pym_dt desc
	</select>

	<select id="isDeliveryInvoiceCheck" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryInvoiceUpdateDto" resultType="boolean">
		select
		    if(ord_prdt_stus in ('D01', 'D02'), false, true) as isDeliveryInvoiceCheck		-- D01 상품준비중, D02 배송중
		  from ord_prdt_info
		 where ord_no = #{orderNo}
		   and ord_prdt_idx = #{orderProductSeq}
		   and prnr_cd = #{partnerCode}
	</select>

	<update id="updateDeliveryInvoice" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryInvoiceUpdateDto">
		insert into ord_shpn_info(ord_no,
		                          ord_prdt_idx,
		                          prdt_cd,
		                          dlvry_stus,
		                          dlvry_cmpny,
		                          invc_no,
		                          invc_inp_dt,
		                          asis_item_idx,
		                          cre_usr_id,
		                          cre_dt,
		                          upd_usr_id,
		                          upd_dt)
		values(#{orderNo},
		       #{orderProductSeq},
		       (select prdt_cd from ord_prdt_info where ord_no = #{orderNo} and ord_prdt_idx = #{orderProductSeq}),
		       'D02',
		       #{deliveryCompanyCode},
		       #{invoiceNo},
		       now(),
		       0,
		       #{userId},
		       now(),
		       #{userId},
		       now()
		       )
		on duplicate key
		update
		    dlvry_cmpny = #{deliveryCompanyCode},
		    dlvry_stus	= 'D02',
		    invc_no		= #{invoiceNo},
		    invc_inp_dt = now(),
		    upd_usr_id	= #{userId},
		    upd_dt		= now()
	</update>

	<update id="updateProductDeliveryStartStatus" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryInvoiceUpdateDto">
		update ord_prdt_info
		   set ord_prdt_stus = 'D02',	-- 배송중
			   upd_usr_id 	 = #{userId},
			   upd_dt		 = now()
		 where ord_no 		 = #{orderNo}
		   and ord_prdt_idx  = #{orderProductSeq}
	</update>

	<update id="updateDelivery" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryMemoUpdateDto">
		-- 송장번호 입력 유무에 대한 체크
		<selectKey resultType="boolean" keyProperty="isInvoiceNo" order="BEFORE">
			select
			    if(count(s.ord_no) = 0, true, false) as isInvoice
			  from ord_prdt_info p
		   	 inner join ord_shpn_info s
			    on p.ord_no = s.ord_no
			   and p.ord_prdt_idx = s.ord_prdt_idx
			   and p.prdt_cd = s.prdt_cd
			 where p.ord_no = #{orderNo}
			   and p.prnr_cd = #{partnerCode}
			   and s.invc_no is not null
		</selectKey>
		update ord_prnr_info
		   set dlvry_memo = #{deliveryMemo},
		       -- 송장번호 미입력 시 수령자 정보 변경 가능
		       <if test="isInvoiceNo">
		       		rcpnt_nm = #{recipientName},
					rcpnt_usr_phn = #{recipientPhone},
					rcpnt_adrs_zip_cd = #{recipientAddressZipCode},
					rcpnt_adrs = #{recipientAddress},
					rcpnt_adrs_sub = #{recipientAddressDetail},
			   </if>
			   upd_usr_id = #{userId},
			   upd_dt = now()
		 where ord_no = #{orderNo}
	</update>

	<sql id="findDeliveryProductSql">
		select
			p.ord_prdt_idx as order_product_seq,
			p.prdt_cd as product_code,
			p.prdt_nm as product_name,
			p.optn_nm as option_name,
			p.prdt_qty as product_qty,
			d.dlvry_cmpny as delivery_company_code,
			cd.intg_cd_val_nm as delivery_company_name,
			d.invc_no as invoice_no,
			d.dlvry_stus as delivery_status_code,
			d.dlvry_stus as delivery_status_name,
			date_format(d.dlvry_st_dt, '%Y-%m-%d') as delivery_start_day,
			date_format(d.dlvry_end_dt, '%Y-%m-%d') as delivery_end_day
		  from ord_prdt_info p
		  left join ord_shpn_info d
		    on p.ord_no = d.ord_no
		   and p.ord_prdt_idx = d.ord_prdt_idx
		   and p.prdt_cd = d.prdt_cd
		  left join com_intg_cd_dtl cd
			on d.dlvry_cmpny = cd.intg_cd_val
		   and cd.intg_cd_id = '000044'
	</sql>
	<select id="findDeliveryProductList" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryFindDto$Param" resultType="kr.wrightbrothers.apps.order.dto.DeliveryProductDto">
		<include refid="findDeliveryProductSql"/>
	    -- 상품 준비 중, 배송중 목록
		 where p.ord_no = #{orderNo}
	       and p.prnr_cd = #{partnerCode}
	       and d.dlvry_stus in ('D01', 'D02')
	</select>
	<select id="findDeliveryCompleteProductList" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryFindDto$Param" resultType="kr.wrightbrothers.apps.order.dto.DeliveryProductDto">
		<include refid="findDeliveryProductSql"/>
		-- 배송완료 주문 목록
		 where p.ord_no = #{orderNo}
		   and p.prnr_cd = #{partnerCode}
		   and d.dlvry_stus = 'D05'
	</select>

</mapper>
