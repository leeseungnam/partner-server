<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.wrightbrothers.apps.order.query.Delivery">

	<select id="findDeliveryList" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryListDto$Param" resultType="kr.wrightbrothers.apps.order.dto.DeliveryListDto$Response">
		-- 배송 관리 목록 조회
		select
			date_format(o.pym_dt, '%Y-%m-%d') as payment_day,
			o.ord_no as order_no,
			m.usr_nm as order_user_name,
			s.ord_stus as delivery_status_code,
			s.ord_stus as delivery_status_name,
			o.pay_meth as payment_method_code,
			o.pay_meth as payment_method_name,
			s.ord_nm as order_name,
			g.delivery_name,
			o.rcpnt_nm as recipient_name,
			o.rcpnt_usr_phn as recipient_phone,
			o.rcpnt_adrs as recipient_address,
			o.rcpnt_adrs_sub as recipient_address_detail
		  from ord_info o
		 inner join ord_prnr_info s
		    on o.ord_no = s.ord_no
		  left join com_mbr_info m
		    on o.ord_usr_id = m.usr_id
		 inner join (
		     select
		         _p.ord_no,
		         concat(
		             if(sum(if(_p.dlvr_tp = 'D01', 1, 0)) > 0, '택배', ''),
					 if(sum(if(_p.dlvr_tp = 'D01', 1, 0)) > 0 and sum(if(_p.dlvr_tp = 'D07', 1, 0)) > 0, ' / ', ''),
					 if(sum(if(_p.dlvr_tp = 'D07', 1, 0)) > 0, '화물', '')
				 ) as delivery_name
		       from ord_prdt_info _p
		       left join ord_shpn_info _d
		       	 on _p.ord_no = _d.ord_no
				and _p.ord_prdt_idx = _d.ord_prdt_idx
				and _p.prdt_cd = _d.prdt_cd
			  where _p.prnr_cd = #{partnerCode}
			<if test="keywordValue == null or keywordValue == ''">
				-- 배송 방법
				<foreach collection="deliveryType" item="item" index="index" open="and _p.dlvr_tp in (" separator="," close=")">
					#{item}
				</foreach>
			</if>
		      group by _p.ord_no
		) g on o.ord_no = g.ord_no
		 where s.prnr_cd = #{partnerCode}
		<choose>
			<when test="keywordValue != null and keywordValue != ''">
				<choose>
					<when test="keywordType == 'NO'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							o.ord_no like #{item} '%'
						</foreach>
					</when>
					<when test="keywordType == 'NAME'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							s.ord_nm like #{item} '%'
						</foreach>
					</when>
					<when test="keywordType == 'USER'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							m.usr_nm like #{item} '%'
						</foreach>
					</when>
				</choose>
			</when>
			<otherwise>
				and	o.pym_dt between concat(#{startDay}, ' 00:00:00.0') and concat(#{endDay}, ' 23:59:59.9')
				-- 배송 상태
				<foreach collection="deliveryStatus" item="item" index="index" open="and s.ord_stus in (" separator="," close=")">
					#{item}
				</foreach>
			</otherwise>
		</choose>
		order by o.pym_dt desc
	</select>

	<select id="isDeliveryStart" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryInvoiceUpdateDto" resultType="boolean">
		select
		    if(count(ord_prdt_idx) != ${orderProductSeqArray.length}, true, false) as isDeliveryStart
		  from ord_prdt_info
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
		   and ord_prdt_stus = 'D01'	-- 상품준비중
		-- 주문상품 SEQ
		<foreach collection="orderProductSeqArray" item="item" index="index" open="and ord_prdt_idx in (" separator="," close=")">
			#{item}
		</foreach>
	</select>

	<update id="updateDeliveryStart" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryInvoiceUpdateDto">
		update ord_shpn_info
		   set dlvry_cmpny = #{deliveryCompanyCode},
		       invc_no = #{invoiceNo},
		       ord_dlvr_stus = 'D02',
		       invc_inp_dt = now(),
		       upd_usr_id = #{userId},
		       upd_dt = now()
		 where ord_no = #{orderNo}
		-- 주문상품 SEQ
		<foreach collection="orderProductSeqArray" item="item" index="index" open="and ord_prdt_idx in (" separator="," close=")">
			#{item}
		</foreach>
		   and ord_dlvr_stus = 'D01';

		update ord_prdt_info
		   set ord_prdt_stus = 'D02',
		       upd_usr_id = #{userId},
		       upd_dt = now()
		 where ord_no = #{orderNo}
		-- 주문상품 SEQ
		<foreach collection="orderProductSeqArray" item="item" index="index" open="and ord_prdt_idx in (" separator="," close=")">
			#{item}
		</foreach>
		   and prnr_cd = #{partnerCode};
	</update>
	
	<update id="updateDelivery" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryUpdateDto">
		update ord_shpn_info
		   set rcpnt_nm = #{recipientName},
		       rcpnt_usr_phn = #{recipientPhone},
		       rcpnt_adrs_zip_cd = #{recipientAddressZipCode},
		       rcpnt_adrs = #{recipientAddress},
		       rcpnt_adrs_sub = #{recipientAddressDetail},
		       upd_usr_id = #{userId},
		       upd_dt = now()
		 where ord_no = #{orderNo}
		   and ord_dlvr_stus = 'D01'
		<foreach collection="orderProductSeqArray" item="item" index="index" open="and ord_prdt_idx in (" separator="," close=")">
			#{item}
		</foreach>
	</update>
	
	<update id="updateDeliveryMemo" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryMemoUpdateDto">
		update ord_prnr_info
		   set dlvry_memo = #{deliveryMemo},
			   upd_usr_id = #{userId},
			   upd_dt = now()
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
	</update>

	<sql id="findDeliveryProductSql">
		select
		    p.ord_no as order_no,
			p.ord_prdt_idx as order_product_seq,
			p.prdt_cd as product_code,
			p.prdt_nm as product_name,
			p.optn_nm as option_name,
			p.prdt_qty as product_qty,
			d.dlvry_cmpny as delivery_company_code,
			cd.intg_cd_val_nm as delivery_company_name,
			d.invc_no as invoice_no,
			d.rcpnt_nm as recipient_name,
			d.rcpnt_usr_phn as recipient_phone,
			concat('(', d.rcpnt_adrs_zip_cd, ') ', d.rcpnt_adrs, if(d.rcpnt_adrs_sub is not null and d.rcpnt_adrs_sub != '', concat(', ', d.rcpnt_adrs_sub), '')) as recipient_address,
			date_format(d.dlvry_st_dt, '%Y-%m-%d') as delivery_start_day,
			date_format(d.dlvry_end_dt, '%Y-%m-%d') as delivery_end_day,
			d.ord_dlvr_stus as delivery_status_code,
			d.ord_dlvr_stus as delivery_status_name
		  from ord_prdt_info p
		  left join ord_shpn_info d
		    on p.ord_no = d.ord_no
		   and p.ord_prdt_idx = d.ord_prdt_idx
		   and p.prdt_cd = d.prdt_cd
		  left join com_intg_cd_dtl cd
			on d.dlvry_cmpny = cd.intg_cd_val
		   and cd.intg_cd_id = '000044'
	</sql>
	<select id="findDeliveryProductList" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryFindDto$Param" resultType="kr.wrightbrothers.apps.order.dto.DeliveryProductDto">
		<include refid="findDeliveryProductSql"/>
	    -- 상품 준비 중, 배송중, 배송완료 목록
		 where p.ord_no = #{orderNo}
	       and p.prnr_cd = #{partnerCode}
	       and d.ord_dlvr_stus in ('D01', 'D02', 'D05')
	</select>
	
	<select id="findExcelDeliveryList" parameterType="kr.wrightbrothers.apps.order.dto.DeliveryExcelDto$Param" resultType="kr.wrightbrothers.apps.order.dto.DeliveryExcelDto$Response">
		select
		    count(*) over (partition by o.ord_no) as order_product_count,
		    count(*) over (partition by o.ord_no, p.prdt_cd) as product_count,
		    date_format(o.pym_dt, '%Y-%m-%d') as payment_day,
		    o.ord_no as order_no,
		    date_format(o.ord_dt, '%Y-%m-%d') as order_day,
		    s.ord_nm as order_name,
		    p.prdt_cd as product_code,
		    p.prdt_nm as product_name,
			if(p.optn_nm is null, '', concat(p.optn_nm, '-', p.optn_val)) as product_option,
			p.prdt_qty as product_qty,
			p.fnl_sell_amt as product_sell_amount,
			p.fnl_sell_amt as product_amount,
			p.dlvr_chrg_amt as product_delivery_charge_amount,
			s.pay_amt as payment_amount,
			m.usr_nm as order_user_name,
			p.dlvr_tp as delivery_type,
			ifnull(d.ord_dlvr_stus, '') as delivery_status,
			ifnull(c.intg_cd_val_nm, '') as delivery_company,
			ifnull(d.invc_no, '') as invoice_no,
			d.rcpnt_nm as recipient_name,
			d.rcpnt_usr_phn as recipient_user_phone,
			ifnull(concat('(', d.rcpnt_adrs_zip_cd, ') ', d.rcpnt_adrs), '') as recipient_address,
			d.rcpnt_adrs_sub as recipient_address_detail,
			ifnull(o.rqst_dtls, '') as request_detail,
			ifnull(s.dlvry_memo, '') as delivery_memo
		  from ord_info o
		 inner join ord_prnr_info s
			on o.ord_no = s.ord_no
		   and s.prnr_cd = #{partnerCode}
		 inner join ord_prdt_info p
			on o.ord_no = p.ord_no
		  left join ord_shpn_info d
			on p.ord_no = d.ord_no
		   and p.ord_prdt_idx = d.ord_prdt_idx
		  left join com_mbr_info m
		  	on o.ord_usr_id = m.usr_id
		  left join com_intg_cd_dtl c
		  	on d.dlvry_cmpny = c.intg_cd_val
		   and c.intg_cd_id = '000044'
		 where o.ord_no in
		<foreach collection="deliveryList" item="item" index="index" open="(" separator="," close=")">
			#{item}
		</foreach>
		 order by o.ord_no desc, p.prdt_cd
	</select>
	
</mapper>
