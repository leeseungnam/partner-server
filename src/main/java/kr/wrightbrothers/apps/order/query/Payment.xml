<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.wrightbrothers.apps.order.query.Payment">

	<select id="isCancelPayment" parameterType="kr.wrightbrothers.apps.order.dto.PaymentCancelDto" resultType="boolean">
		-- 결제 취소 / 취소 요청 상태 확인
		select
		    if(count(ord_prdt_idx) = ${orderProductSeq.length}, true, false) as isCancelPayment
		  from ord_prdt_info
		 where ord_no = #{orderNo}
		   and ord_prdt_stus in ('O06', 'O07')
		<foreach collection="orderProductSeq" item="item" index="index" open="and ord_prdt_idx in (" separator="," close=")">
			#{item}
		</foreach>
	</select>

	<select id="isAfterOrderComplete" parameterType="kr.wrightbrothers.apps.order.dto.PaymentCancelDto" resultType="boolean">
		-- 상품 준비중 상태인지 여부 확인
		select
		    if(ord_stus in ('O05'), false, true) as isAfterOrderComplete
		  from ord_prnr_info
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
	</select>

	<select id="findPaymentToOrder" parameterType="kr.wrightbrothers.apps.order.dto.OrderFindDto$Param" resultType="kr.wrightbrothers.apps.order.dto.PaymentDto">
		-- 주문내역 상세정보 시 결제정보 조회
		select
		    s.ord_amt as order_amount,
		    s.dlvr_chrg_amt as delivery_charge_amount,
		    s.pay_amt as payment_amount,
		    p.pym_dt as payment_date,
		    p.pay_meth as payment_method_code,
		    p.pay_meth as payment_method_name,
		    s.pay_stus as payment_status_code,
		    s.pay_stus as payment_status_name,
		    s.cnc_dt as cancel_date,
		    if(s.cnc_rsn_cd = 'C99', s.cnc_rsn, cd.intg_cd_val_nm) as cancel_reason
		  from ord_pay_info p
		 inner join ord_prnr_info s
		    on p.ord_no = s.ord_no
		   and s.prnr_cd = #{partnerCode}
		  left join com_intg_cd_dtl cd
		    on s.cnc_rsn_cd = cd.intg_cd_val
		   and cd.intg_cd_id = '000074'
		 where p.ord_no = #{orderNo}
	</select>

	<update id="updateRequestCancelOrderPartner" parameterType="kr.wrightbrothers.apps.order.dto.PaymentCancelDto">
		-- 파트너 결제 취소요청
		update ord_prnr_info
		   set pay_stus = 'S09',	-- 취소요청 코드
		       ord_stus = 'O06',	-- 취소요청 코드
		       cnc_dt = now(),
		       <if test="cancelReasonCode != null and cancelReasonCode != ''.toString()">
				   cnc_rsn_cd = #{cancelReasonCode},
			   </if>
		       upd_usr_id = #{userId},
		       upd_dt = now()
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
	</update>

	<update id="updateRequestCancelOrderProduct" parameterType="kr.wrightbrothers.apps.order.dto.PaymentCancelDto">
		-- 주문 상품 취소 요청 처리
		update ord_prdt_info
		   set ord_prdt_stus= 'O06',	-- 취소요청 코드
		       cnc_rsn_cd	= #{cancelReasonCode},
		       cnc_rq_dt	= now(),
			   upd_usr_id	= #{userId},
			   upd_dt		= now()
		 where ord_no 		= #{orderNo}
		<foreach collection="orderProductSeq" item="item" index="index" open="and ord_prdt_idx in (" separator="," close=")">
			#{item}
		</foreach>
	</update>

	<update id="updatePaymentDetailRefundInfo" parameterType="kr.wrightbrothers.apps.order.dto.PaymentCancelDto">
		-- 취소 요청 후 환불 정보에 대한 수정으로
		-- 불필요 한 수정자, 수정일시는 제외(로직 변경 시 해당부분 추가할 것)
		update ord_pay_info
		   set cnc_bank_cd		= ifnull(cnc_bank_cd, #{refundBankCode}),
			   cnc_bank_acnt_no = ifnull(cnc_bank_acnt_no, #{refundBankAccountNo}),
			   cnc_rmtr_nm		= ifnull(cnc_rmtr_nm, #{refundDepositorName})
		 where ord_no = #{orderNo}
	</update>

	<select id="isCancelPartialPayment" parameterType="kr.wrightbrothers.apps.order.dto.PaymentCancelDto" resultType="boolean">
		-- 부분취소를 지원 안하는 관계로 등록되어있는 상품 수와 취소 요청 상품 수 일치여부 확인
		select
			if(count(ord_prdt_idx) != ${orderProductSeq.length}, true, false) as isPartialPaymentCancel
		  from ord_prdt_info
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
	</select>

	<select id="findBankInfo" parameterType="java.lang.String" resultType="kr.wrightbrothers.apps.order.dto.PaymentCancelDto$BankInfo">
		select
			cnc_bank_cd as bank_cd,
			cnc_bank_acnt_no as bank_acnt_no,
			cnc_rmtr_nm as dpstr_nm
		  from ord_pay_info
		 where ord_no = #{orderNo}
	</select>

</mapper>
