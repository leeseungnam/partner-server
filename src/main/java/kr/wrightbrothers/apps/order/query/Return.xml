<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.wrightbrothers.apps.order.query.Return">

	<select id="isRequestReturn" parameterType="kr.wrightbrothers.apps.order.dto.RequestReturnUpdateDto" resultType="boolean">
		select
		    if(count(ord_no) = 1, true, false) as isRequestReturn
		  from ord_prnr_info
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
		   and ord_stus = #{returnProcessCode}
	</select>

	<select id="findReturnList" parameterType="kr.wrightbrothers.apps.order.dto.ReturnListDto$Param" resultType="kr.wrightbrothers.apps.order.dto.ReturnListDto$Response">
		select
		    date_format(g.cnc_rq_dt, '%Y-%m-%d') as return_request_day,
		    o.ord_no as order_no,
			date_format(o.ord_dt, '%Y-%m-%d') as order_day,
			m.usr_nm as order_user_name,
			g.ord_prdt_stus as order_product_status_code,
			g.ord_prdt_stus as order_product_status_name,
			s.ord_stus as order_status_code,
			s.ord_stus as order_status_name,
			p.pay_meth as payment_method_code,
			p.pay_meth as payment_method_name,
			s.ord_nm as order_name,
			g.prdt_nm as product_name,
			s.cnc_rsn_cd as return_reason,
			s.ord_amt as order_amount,
			g.fnl_sell_amt as final_sell_amount,
			date_format(s.cnc_dt, '%Y-%m-%d') as cancel_day,
			s.pay_stus as payment_status_code,
			s.pay_stus as payment_status_name
		  from ord_info o
		 inner join ord_prnr_info s
		    on o.ord_no = s.ord_no
		   and s.prnr_cd = #{partnerCode}
		 inner join ord_pay_info p
			on o.ord_no = p.ord_no
		 inner join ord_prdt_info g
			on o.ord_no = g.ord_no
		  left join com_mbr_info m
		    on o.ord_usr_id = m.usr_id
		 where g.prnr_cd = #{partnerCode}
		<choose>
			<when test="keywordValue != null and keywordValue != ''">
				<choose>
					<when test="keywordType == 'NO'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							o.ord_no like #{item} '%'
						</foreach>
					</when>
					<when test="keywordType == 'NAME'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							o.ord_nm like #{item} '%'
						</foreach>
					</when>
					<when test="keywordType == 'USER'">
						<foreach collection="keywordValueList" item="item" index="index" open="and (" separator="OR" close=")">
							m.usr_nm like #{item} '%'
						</foreach>
					</when>
				</choose>
		 		order by g.cnc_rq_dt desc
			</when>
			<otherwise>
				<foreach collection="returnStatus" item="item" index="index" open="and g.ord_prdt_stus in (" separator="," close=")">
					#{item}
				</foreach>
				<choose>
					<when test="rangeType == 'PAYMENT'.toString()">
						and p.pym_dt between concat(#{startDay}, ' 00:00:00.0') and concat(#{endDay}, ' 23:59:59.9')
						order by p.pym_dt desc
		 			</when>
					<when test="rangeType == 'CANCEL'.toString()">
						and s.cnc_dt between concat(#{startDay}, ' 00:00:00.0') and concat(#{endDay}, ' 23:59:59.9')
						order by s.cnc_dt desc
					</when>
					<when test="rangeType == 'RETURN'.toString()">
						and g.cnc_rq_dt between concat(#{startDay}, ' 00:00:00.0') and concat(#{endDay}, ' 23:59:59.9')
						order by g.cnc_rq_dt desc
					</when>
				</choose>
			</otherwise>
		</choose>
	</select>

	<update id="updateReturn" parameterType="kr.wrightbrothers.apps.order.dto.ReturnMemoUpdateDto">
		-- 송장번호 입력 유무에 대한 체크
		<selectKey resultType="boolean" keyProperty="isInvoiceNo" order="BEFORE">
			select
			    if(count(d.ord_prdt_idx) = 0, true, false) as isInvoice
			  from ord_prdt_info p
			 inner join ord_shpn_info d
			    on p.ord_no = d.ord_no
			   and p.ord_prdt_idx = d.ord_prdt_idx
			   and p.prdt_cd = d.prdt_cd
			 where p.ord_no = #{orderNo}
			   and p.prnr_cd = #{partnerCode}
			   and d.invc_no is not null
		</selectKey>
		update ord_prnr_info
		   set rtrn_memo = #{returnMemo},
		       -- 송장번호 미입력 시 수령자 정보 변경 가능
		       <if test="isInvoiceNo">
				   rcpnt_usr_phn = #{recipientPhone},
				   rcpnt_adrs_zip_cd = #{recipientAddressZipCode},
				   rcpnt_adrs = #{recipientAddress},
				   rcpnt_adrs_sub = #{recipientAddressDetail},
			   </if>
			   upd_usr_id = #{userId},
			   upd_dt = now()
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
	</update>

	<select id="findReturnProductList" parameterType="kr.wrightbrothers.apps.order.dto.ReturnFindDto$Param" resultType="kr.wrightbrothers.apps.order.dto.ReturnProductDto">
		select
		    p.ord_prdt_idx as order_product_seq,
		    p.prdt_cd as product_code,
		    p.prdt_nm as product_name,
		    p.optn_nm as option_name,
		    p.fnl_sell_amt as final_sell_amount,
			date_format(p.cnc_rq_dt, '%Y-%m-%d') as return_request_day,
			p.prdt_qty as product_qty,
			p.ord_prdt_stus as order_product_status_code,
			p.ord_prdt_stus as order_product_status_name,
			d.rtrn_dlvry_cmpny as return_delivery_company_code,
			cd.intg_cd_val_nm as return_delivery_company_name,
			d.rtrn_invc_no as return_invoice_no,
			if(p.ord_prdt_stus = 'R04', p.non_rtn_tp_cd, p.cnc_rsn) as reason
		  from ord_prdt_info p
		  left join ord_shpn_info d
		  	on p.ord_no = d.ord_no
		   and p.ord_prdt_idx = d.ord_prdt_idx
		   and p.prdt_cd = d.prdt_cd
		  left join com_intg_cd_dtl cd
		    on d.rtrn_dlvry_cmpny = cd.intg_cd_val
		   and cd.intg_cd_id = '000044'
		  left join com_intg_cd_dtl rcd
		    on p.non_rtn_tp_cd = rcd.intg_cd_val
		   and cd.intg_cd_id = '000085'
		 where p.ord_no = #{orderNo}
		   and p.prnr_cd = #{partnerCode}
		   and p.ord_prdt_stus in ('R01', 'R02', 'R03', 'R04', 'R05')	-- 반품요청, 반품취소, 반품진행, 반품불가, 반품완료
		 order by p.ord_prdt_idx
	</select>

	<select id="findOrderProductStatusCode" parameterType="kr.wrightbrothers.apps.order.dto.RequestReturnUpdateDto" resultType="java.lang.String">
		select
		    ord_prdt_stus as order_product_status_code
		  from ord_prdt_info order_product
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
		   and ord_prdt_idx = #{orderProductSeq}
	</select>

	<update id="updateOrderProductReturnCode" parameterType="kr.wrightbrothers.apps.order.dto.RequestReturnUpdateDto">
		update ord_prdt_info
		   set ord_prdt_stus = #{returnProcessCode},
		       -- 반풀불가 처리 시 반품 사유 등록
		       <if test="returnProcessCode == 'R04'.toString()">
				   non_rtn_tp_cd = #{requestCode},
				   non_rtn_dt = now(),
			   </if>
		       upd_usr_id = #{userId},
		       upd_dt = now()
		 where ord_no = #{orderNo}
		   and ord_prdt_idx = #{orderProductSeq}
	</update>

	<update id="updateOrderReturnCode" parameterType="kr.wrightbrothers.apps.order.dto.RequestReturnUpdateDto">
		update ord_prnr_info
		   set ord_stus = #{returnProcessCode},
		       upd_usr_id = #{userId},
		       upd_dt = now()
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
	</update>

	<select id="findNonCancelOrderProduct" parameterType="kr.wrightbrothers.apps.order.dto.ReturnFindDto$Param" resultType="kr.wrightbrothers.apps.order.dto.DeliveryProductDto">
		select
			p.ord_prdt_idx as order_product_seq,
			p.prdt_cd as product_code,
			p.prdt_nm as product_name,
			p.optn_nm as option_name,
			p.prdt_qty as product_qty,
			cd.intg_cd_val as delivery_company_code,
			cd.intg_cd_val_nm as delivery_company_name,
			d.invc_no as invoice_no,
			d.ord_dlvr_stus as delivery_status_code,
			d.ord_dlvr_stus as delivery_status_name,
			date_format(d.dlvry_st_dt, '%Y-%m-%d') as delivery_start_day,
			date_format(d.dlvry_end_dt, '%Y-%m-%d') as delivery_end_day
		  from ord_prdt_info p
		  left join ord_shpn_info d
		    on p.ord_no = d.ord_no
		   and p.ord_prdt_idx = d.ord_prdt_idx
		   and p.prdt_cd = d.prdt_cd
		  left join com_intg_cd_dtl cd
		    on d.dlvry_cmpny = cd.intg_cd_val
		   and cd.intg_cd_id = '000044'
		 where p.ord_no = #{orderNo}
		   and p.prnr_cd = #{partnerCode}
		   and p.ord_prdt_stus not in ('O06', 'O07')
	</select>

	<update id="updateOrderDeliveryReturn" parameterType="kr.wrightbrothers.apps.order.dto.RequestReturnUpdateDto">
		update ord_shpn_info
		   set rtrn_dlvry_cmpny = #{requestCode},
		       rtrn_invc_no		= #{requestValue},
		       rtrn_invc_inp_dt = ifnull(rtrn_invc_inp_dt, now()),
		       upd_usr_id		= #{userId},
		       upd_dt			= now()
		 where ord_no = #{orderNo}
		   and ord_prdt_idx = #{orderProductSeq}
	</update>

	<update id="updateRequestReturnOrderPartner" parameterType="kr.wrightbrothers.apps.order.dto.RequestReturnUpdateDto">
		-- 파트너 반품완료로 인한 취소요청
		update ord_prnr_info
		   set pay_stus = 'S09',	-- 취소요청 코드
		       ord_stus = 'R01',	-- 취소요청 코드
		       upd_usr_id = #{userId},
		       upd_dt = now()
		 where ord_no = #{orderNo}
		   and prnr_cd = #{partnerCode}
	</update>

	<select id="findExcelReturnList" parameterType="kr.wrightbrothers.apps.order.dto.ReturnExcelDto$Param" resultType="kr.wrightbrothers.apps.order.dto.ReturnExcelDto$Response">
		select
			count(*) over (partition by o.ord_no) as order_product_count,
			count(*) over (partition by o.ord_no, p.prdt_cd) as product_count,
			date_format(p.cnc_rq_dt, '%Y-%m-%d') as request_return_day,
			o.ord_no as order_no,
			date_format(o.ord_dt, '%Y-%m-%d') as order_day,
			s.ord_nm as order_name,
			p.prdt_cd as product_code,
			p.prdt_nm as product_name,
			if(p.optn_nm is null, '', concat(p.optn_nm, '-', p.optn_val)) as product_option,
			p.prdt_qty as product_qty,
			p.fnl_sell_amt as product_sell_amount,
			p.fnl_sell_amt as product_amount,
			p.dlvr_chrg_amt as product_delivery_charge_amount,
			s.pay_amt as payment_amount,
			m.usr_nm as order_user_name,
			p.dlvr_tp as delivery_type,
			p.cnc_cplt_dt as complete_return_day,
			p.ord_prdt_stus as return_status,
			ifnull(c.intg_cd_val_nm, '') as delivery_company,
			ifnull(d.rtrn_invc_no, '') as invoice_no,
			s.rcpnt_nm as recipient_name,
			s.rcpnt_usr_phn as recipient_user_phone,
			ifnull(concat('(', s.rcpnt_adrs_zip_cd, ') ', s.rcpnt_adrs), '') as recipient_address,
			s.rcpnt_adrs_sub as recipient_address_detail,
			ifnull(r.intg_cd_val_nm, '') as reason
		  from ord_info o
		 inner join ord_prnr_info s
			on o.ord_no = s.ord_no
		   and s.prnr_cd = #{partnerCode}
		 inner join ord_prdt_info p
			on o.ord_no = p.ord_no
		 inner join ord_pay_info pi
			on o.ord_no = pi.ord_no
		  left join ord_shpn_info d
			on p.ord_no = d.ord_no
		   and p.ord_prdt_idx = d.ord_prdt_idx
		  left join com_mbr_info m
			on o.ord_usr_id = m.usr_id
		  left join com_intg_cd_dtl c
			on d.rtrn_dlvry_cmpny = c.intg_cd_val
		  and c.intg_cd_id = '000044'
		 left join com_intg_cd_dtl r
		   on p.non_rtn_tp_cd = r.intg_cd_val
		  and r.intg_cd_id = '000085'
		where o.ord_no in
		<foreach collection="returnList" item="item" index="index" open="(" separator="," close=")">
			#{item}
		</foreach>
		 order by o.ord_no desc, p.prdt_cd
	</select>

</mapper>
